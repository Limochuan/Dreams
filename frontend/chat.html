<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dreams Chat</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      font-family: Arial, Helvetica, sans-serif;
    }

    .wrap {
      max-width: 820px;
      margin: 0 auto;
      padding: 16px;
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }

    #chat {
      height: 380px;
      overflow-y: auto;
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
    }

    .msg {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 6px;
    }

    .meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      margin-top: 10px;
    }

    input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      /* ✨ 修复：防止 padding 撑大宽度导致溢出 */
      box-sizing: border-box;
    }

    button {
      padding: 10px 12px;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }
    
    button:hover {
        background-color: #0056b3;
    }

    .small {
      font-size: 12px;
      color: #666;
    }

    .err {
      color: #b00020;
      white-space: pre-wrap;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <h2 id="title">Dreams Chat</h2>
      <button onclick="goBack()" style="background-color: #6c757d;">返回</button>
    </div>

    <div class="card">
      <div class="small" id="info"></div>
      <div class="small" id="wsStatus">正在连接...</div>
    </div>

    <div class="card" id="groupOps" style="display:none;">
      <h3>群管理</h3>
      <div class="small">输入 UID 拉人进群</div>
      <div class="grid">
        <input id="new_uid" placeholder="例如 3" />
        <button onclick="addMember()">添加</button>
      </div>
      <div id="err_add" class="err"></div>
    </div>

    <div class="card">
      <h3>消息</h3>

      <div id="chat"></div>

      <div class="grid">
        <input id="msg" placeholder="输入消息，回车发送" />
        <button onclick="sendMsg()">发送</button>
      </div>

      <div id="err" class="err"></div>
    </div>
  </div>

  <script src="./app.js"></script>

  <script>
    /*
      ===== 全局变量 =====
    */

    let me = null;              // 当前登录用户信息
    let ws = null;              // WebSocket 实例

    // 从 URL 中读取参数
    const cid = parseInt(Dreams.getQueryParam("cid"), 10);
    const type = Dreams.getQueryParam("type"); // private / group


    /*
      ===== 页面初始化 =====
    */
    (async function init() {

      // 获取当前登录用户
      me = await Dreams.apiMe();
      if (!me) {
        location.href = "./login.html";
        return;
      }

      // 没有会话 ID，返回会话列表
      if (!cid) {
        location.href = "./conversations.html";
        return;
      }

      // 显示基本信息
      document.getElementById("title").innerText = "Dreams - #" + cid;
      document.getElementById("info").innerText =
        "conversation_id=" + cid +
        " | type=" + (type || "unknown") +
        " | my_uid=" + me.uid;

      // 如果是群聊，显示群管理
      if (type === "group") {
        document.getElementById("groupOps").style.display = "block";
      }

      // 加载历史消息
      await loadHistory();

      // 建立 WebSocket 连接
      connectWS();

      // 回车发送消息
      document.getElementById("msg").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          sendMsg();
        }
      });

    })();


    /*
      ===== 拉取历史消息 =====
    */
    async function loadHistory() {
      // ✨ 修改：直接调用 apiGet，不需要手动拼 token，app.js 会处理
      const res = await Dreams.apiGet(
        "/api/conversations/" + cid + "/messages?limit=50"
      );

      if (res.error) {
        showErr("err", res.error);
        return;
      }

      const chat = document.getElementById("chat");
      chat.innerHTML = "";

      for (const m of res.items || []) {
        appendMessage({
          sender_uid: m.sender_uid,
          content: m.content,
          created_at: m.created_at
        });
      }

      chat.scrollTop = chat.scrollHeight;
    }


    /*
      ===== WebSocket 连接 (核心修改) =====
    */
    function connectWS() {
      // ✨ 修改：使用 app.js 封装的 connectChat，自动处理 URL 签名
      // 参数 1: 会话 ID
      // 参数 2: 收到消息的回调函数
      ws = Dreams.connectChat(cid, (data) => {
          if (data.type === "system") {
            appendSystem(data);
          }
          if (data.type === "message") {
            appendMessage(data);
          }
      });

      // 绑定 UI 状态更新 (使用 addEventListener 避免覆盖 app.js 内部逻辑)
      if (ws) {
          ws.addEventListener("open", () => {
              document.getElementById("wsStatus").innerText = "WebSocket 已连接";
              document.getElementById("wsStatus").style.color = "green";
          });
          
          ws.addEventListener("close", () => {
              document.getElementById("wsStatus").innerText = "WebSocket 已断开";
              document.getElementById("wsStatus").style.color = "red";
          });

          ws.addEventListener("error", () => {
              document.getElementById("wsStatus").innerText = "WebSocket 出错";
              document.getElementById("wsStatus").style.color = "red";
          });
      }
    }


    /*
      ===== 显示系统消息（进群、离群）=====
    */
    function appendSystem(p) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "msg";
      div.style.backgroundColor = "#f0f0f0"; // 区分系统消息
      div.innerHTML =
        "<div class='meta' style='color:#888'>SYSTEM</div>" +
        "<div style='font-size:12px; color:#555'>" + Dreams.escapeHtml(p.event) +
        " | uid=" + p.uid +
        " | device=" + (p.device || "unknown") +
        "</div>";
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }


    /*
      ===== 显示普通聊天消息 =====
    */
    function appendMessage(p) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "msg";
      
      // 简单的样式区分：如果是自己发的，背景稍微变色（可选）
      if (me && p.sender_uid === me.uid) {
          div.style.backgroundColor = "#e8f5ff";
      }

      div.innerHTML =
        "<div class='meta'>UID " + p.sender_uid +
        " " + (p.created_at || "") +
        "</div>" +
        "<div>" + Dreams.escapeHtml(p.content) + "</div>";

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }


    /*
      ===== 发送消息 =====
    */
    function sendMsg() {
      clearErr("err");

      const input = document.getElementById("msg");
      const text = input.value.trim();
      if (!text) return;

      if (!ws || ws.readyState !== WebSocket.OPEN) {
        showErr("err", "WebSocket 未连接");
        return;
      }

      // 发送消息
      ws.send(JSON.stringify({ content: text }));
      input.value = "";
    }


    /*
      ===== 群聊添加成员 =====
    */
    async function addMember() {
      clearErr("err_add");

      const uid = parseInt(document.getElementById("new_uid").value, 10);
      if (!uid) {
        showErr("err_add", "UID 必须是数字");
        return;
      }

      // ✨ 修改：直接调用 apiPost，body 里不需要传 token
      const res = await Dreams.apiPost(
        "/api/conversations/" + cid + "/members",
        {
          new_uid: uid
        }
      );

      if (res.error) {
        showErr("err_add", res.error);
      } else {
        document.getElementById("new_uid").value = "";
        alert("添加成功！");
      }
    }


    /*
      ===== 返回会话列表 =====
    */
    function goBack() {
      location.href = "./conversations.html";
    }


    /*
      ===== 错误显示工具 =====
    */
    function showErr(id, msg) {
      document.getElementById(id).innerText = msg;
    }

    function clearErr(id) {
      document.getElementById(id).innerText = "";
    }

  </script>
</body>
</html>
