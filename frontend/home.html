<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dreams</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ================= Ê†∑ÂºèÂå∫ (‰øùÊåÅ‰πãÂâçÁöÑÈ´òÁ∫ßÊÑüËÆæËÆ°) ================= */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #e6e6e6; font-family: "Microsoft YaHei", sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    .app-window { width: 1300px; height: 850px; background: #fff; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.15); display: flex; overflow: hidden; position: relative; }

    /* Â∑¶‰æß */
    .sidebar-nav { width: 68px; background: #2e2e2e; display: flex; flex-direction: column; align-items: center; padding-top: 30px; color: #9d9d9d; }
    .my-avatar { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 25px; cursor: pointer; border: 2px solid transparent; }
    .my-avatar:hover { border-color: #fff; }
    .nav-item { font-size: 24px; margin-bottom: 25px; cursor: pointer; position: relative; }
    .nav-item:hover { color: #fff; } .nav-item.active { color: #0099ff; }
    .nav-bottom { margin-top: auto; margin-bottom: 20px; font-size: 20px; }
    .nav-badge { position: absolute; top: -5px; right: -5px; width: 8px; height: 8px; background: #ff4d4f; border-radius: 50%; display: none; }
    .nav-badge.show { display: block; }

    /* ÂàóË°®Ê†è */
    .sidebar-list { width: 300px; background: #fdfdfd; border-right: 1px solid #e7e7e7; display: flex; flex-direction: column; }
    .panel { flex: 1; display: none; flex-direction: column; } .panel.active { display: flex; }
    .search-box { padding: 20px 15px; background: #f7f7f7; display: flex; align-items: center; justify-content: space-between; }
    .search-input-wrap { position: relative; flex: 1; margin-right: 10px; }
    .search-input { width: 100%; padding: 8px 10px 8px 30px; border: 1px solid #e0e0e0; background: #e9e9e9; border-radius: 4px; outline: none; font-size: 13px; }
    .search-icon { position: absolute; left: 10px; top: 9px; color: #999; font-size: 12px; }
    .btn-create { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #e9e9e9; border-radius: 4px; cursor: pointer; color: #666; }
    .scroll-area { flex: 1; overflow-y: auto; }
    
    .session-item { display: flex; padding: 12px 15px; cursor: pointer; } .session-item:hover { background: #f2f2f2; } .session-item.active { background: #e5f5ff; }
    .session-item.pinned { background: #f7f7f7; border-left: 3px solid #0099ff; }
    .s-avatar { width: 44px; height: 44px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
    .s-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
    .s-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .s-name { font-size: 14px; color: #000; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
    .unread-badge { background: #ff4d4f; color: white; border-radius: 10px; padding: 0 6px; font-size: 10px; height: 16px; line-height: 16px; min-width: 16px; text-align: center; margin-left: 5px;}
    .friend-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; } .friend-item:hover { background: #f2f2f2; }
    .f-name { font-size: 14px; margin-left: 12px; font-weight: 500; }

    /* ËÅäÂ§©Âå∫ */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #f5f5f5; min-width: 0; }
    .chat-header { height: 60px; border-bottom: 1px solid #e7e7e7; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; background: #f5f5f5; }
    .chat-title { font-size: 18px; font-weight: bold; color: #000; cursor: default; }
    .chat-title.editable { cursor: pointer; } .chat-title.editable:hover { color: #0099ff; text-decoration: underline; }
    .header-icons { display: flex; gap: 20px; color: #333; font-size: 18px; cursor: pointer; }
    .messages-box { flex: 1; overflow-y: auto; padding: 20px 30px; display: flex; flex-direction: column; gap: 20px; }
    .msg-row { display: flex; align-items: flex-start; gap: 12px; } .msg-row.me { flex-direction: row-reverse; }
    .msg-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
    .bubble { padding: 10px 14px; background: #fff; border-radius: 10px; font-size: 14px; line-height: 1.6; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-break: break-word; }
    .msg-row.me .bubble { background: #0099ff; color: #fff; border-top-right-radius: 2px; } .msg-row:not(.me) .bubble { border-top-left-radius: 2px; }
    .bubble img { max-width: 200px; border-radius: 4px; cursor: pointer; }
    .input-box { height: 180px; border-top: 1px solid #e7e7e7; background: #fff; display: flex; flex-direction: column; }
    .toolbar { padding: 10px 20px; display: flex; gap: 20px; color: #666; font-size: 18px; }
    textarea { flex: 1; border: none; outline: none; padding: 0 20px; font-size: 14px; font-family: inherit; resize: none; }
    .btn-send { padding: 6px 25px; background: #0099ff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }

    /* ÊàêÂëòÊ†è */
    .member-sidebar { width: 200px; background: #fff; border-left: 1px solid #e7e7e7; display: none; flex-direction: column; }
    .member-header { height: 50px; border-bottom: 1px solid #f0f0f0; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #666; }
    .member-scroll { flex: 1; overflow-y: auto; padding: 5px 0; }
    .member-item { display: flex; align-items: center; padding: 8px 15px; cursor: pointer; position: relative; }
    .member-item:hover { background: #f5f5f5; }
    /* Ë∏¢‰∫∫ÊåâÈíÆ */
    .btn-kick { display: none; position: absolute; right: 10px; color: #ff4d4f; font-size: 12px; padding: 2px 5px; border: 1px solid #ff4d4f; border-radius: 4px; z-index: 10; background: #fff; }
    .member-item:hover .btn-kick { display: block; } 
    .m-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
    .m-name { font-size: 12px; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .badge { font-size: 10px; padding: 1px 4px; border-radius: 2px; color: #fff; margin-left: 5px; transform: scale(0.9); }
    .badge-owner { background: #f0ad4e; } .badge-admin { background: #5bc0de; }

    /* ËèúÂçï */
    .context-menu { display: none; position: absolute; background: white; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 5000; min-width: 120px;}
    .ctx-item { padding: 10px 15px; font-size: 13px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 8px;}
    .ctx-item:hover { background: #f5f5f5; color: #0099ff; }
    .lang-options { display: none; background: #f9f9f9; } .lang-options.show { display: block; }
    .lang-item { padding: 8px 35px; font-size: 13px; color: #666; cursor: pointer; } .lang-item:hover { color: #0099ff; background: #eee; }

    /* ÂºπÁ™ó & Á©∫Áä∂ÊÄÅ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; justify-content: center; align-items: center; }
    .profile-card { background: white; width: 340px; border-radius: 12px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.3); position: relative; }
    .p-banner { height: 100px; background: linear-gradient(135deg, #00c6ff, #0072ff); }
    .p-close { position: absolute; top: 10px; right: 15px; color: #fff; cursor: pointer; font-size: 20px; }
    .p-avatar-wrap { position: absolute; top: 60px; left: 20px; padding: 4px; background: white; border-radius: 50%; }
    .p-avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #eee;}
    .p-info { padding: 45px 20px 20px; }
    .btn-action { width: 100%; padding: 10px; border: none; border-radius: 6px; background: #0099ff; color: white; font-weight: bold; cursor: pointer; }
    .empty-state { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ccc; }
    .empty-icon { font-size: 60px; margin-bottom: 20px; color: #e0e0e0; }
  </style>
</head>
<body onclick="hideAllMenus()">

<div class="app-window">
    <div class="sidebar-nav">
        <img id="myAvatar" class="my-avatar" src="" onclick="showProfile(me.uid)">
        
        <div class="nav-item active" id="tabChat" onclick="switchTab('chat')">
            <i class="fas fa-comment-dots"></i><div class="nav-badge" id="totalBadge"></div>
        </div>
        <div class="nav-item" id="tabFriend" onclick="switchTab('friend')">
            <i class="fas fa-user-friends"></i>
        </div>
        
        <div class="nav-bottom"><i class="fas fa-bars nav-item" onclick="toggleMenu(event, 'sysMenu')"></i></div>
        
        <div class="context-menu" id="sysMenu" style="bottom:20px; left:60px;" onclick="event.stopPropagation()">
            <div class="ctx-item" onclick="toggleLang()"><i class="fas fa-globe"></i> <span data-i18n="menu_lang">ËØ≠Ë®Ä</span></div>
            <div class="lang-options" id="langOpts">
                <div class="lang-item" onclick="changeLang('zh')">üá®üá≥ ‰∏≠Êñá</div>
                <div class="lang-item" onclick="changeLang('id')">üáÆüá© Indonesia</div>
                <div class="lang-item" onclick="changeLang('en')">üá∫üá∏ English</div>
            </div>
            <div style="height:1px; background:#eee; margin:4px 0;"></div>
            <div class="ctx-item" onclick="Dreams.logout()" style="color:#ff4d4f"><i class="fas fa-sign-out-alt"></i> <span data-i18n="menu_exit">ÈÄÄÂá∫</span></div>
        </div>
    </div>

    <div class="sidebar-list">
        <div class="panel active" id="panelChat">
            <div class="search-box">
                <div class="search-input-wrap"><i class="fas fa-search search-icon"></i><input class="search-input" id="searchUidInput" data-i18n-placeholder="search_placeholder" placeholder="ÊêúÁ¥¢ UID Âä†Â•ΩÂèã"></div>
                <div class="btn-create" onclick="createNewChat()"><i class="fas fa-plus"></i></div>
            </div>
            <div class="scroll-area" id="convList"></div>
        </div>
        <div class="panel" id="panelFriend">
            <div class="search-box"><span style="font-weight:bold" data-i18n="contact_title">ËÅîÁ≥ª‰∫∫</span></div>
            <div class="scroll-area" id="friendList"></div>
        </div>
    </div>

    <div class="chat-area">
        <div id="emptyState" class="empty-state"><i class="fas fa-comments empty-icon"></i><div data-i18n="empty_chat">Êú™ÈÄâÊã©‰ºöËØù</div></div>
        
        <div id="chatInterface" style="display: none; height: 100%; flex-direction: column;">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle" onclick="editGroupTitle()"></div>
                <div class="header-icons">
                    <label for="groupAvatarInput" id="btnGroupAvatar" style="display:none; cursor:pointer" title="‰øÆÊîπÁæ§Â§¥ÂÉè">
                        <i class="fas fa-camera tool-icon"></i>
                    </label>
                    <input type="file" id="groupAvatarInput" accept="image/*" style="display:none" onchange="uploadGroupAvatar(this)">
                    
                    <i class="fas fa-ellipsis-h tool-icon" onclick="toggleMembers()"></i>
                </div>
            </div>
            <div class="messages-box" id="msgBox"></div>
            <div class="input-box">
                <div class="toolbar">
                    <i class="far fa-smile tool-icon"></i>
                    <label for="imgInput" style="cursor:pointer"><i class="far fa-image tool-icon"></i></label>
                    <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(this)">
                </div>
                <textarea id="msgInput"></textarea>
                <div class="send-area"><button class="btn-send" onclick="sendMsg()" data-i18n="send_btn">ÂèëÈÄÅ(S)</button></div>
            </div>
        </div>
    </div>

    <div class="member-sidebar" id="memberSidebar">
        <div class="member-header">
            <span><span data-i18n="group_members">Áæ§ÊàêÂëò</span> (<span id="memberCount">0</span>)</span>
            <i class="fas fa-user-plus btn-add-member" onclick="addGroupMember()" id="btnAddMember" style="display:none"></i>
        </div>
        <div class="member-scroll" id="memberList"></div>
    </div>
</div>

<div id="ctxMenu" class="context-menu">
    <div class="ctx-item" id="ctxPin" onclick="toggleSetting('pin')">ÁΩÆÈ°∂</div>
    <div class="ctx-item" id="ctxMute" onclick="toggleSetting('mute')">ÂÖçÊâìÊâ∞</div>
</div>

<div id="profileModal" class="modal-overlay" onclick="closeProfile()"><div class="profile-card" onclick="event.stopPropagation()"><div class="p-banner"></div><div class="p-close" onclick="closeProfile()">√ó</div><div class="p-avatar-wrap"><img id="pAvatar" class="p-avatar"></div><div class="p-info"><div class="p-name" id="pName"></div><div class="p-row"><span id="pUid"></span></div><div class="p-action" id="pAction"></div></div></div></div>

<script src="./app.js"></script>
<script>
    // ================= ÂõΩÈôÖÂåñÂ≠óÂÖ∏ (ÂÆåÊï¥Áâà) =================
    const translations = {
        zh: {
            empty_chat: "Êú™ÈÄâÊã©‰ºöËØù", send_btn: "ÂèëÈÄÅ(S)", menu_lang: "ËØ≠Ë®Ä", menu_exit: "ÈÄÄÂá∫",
            search_placeholder: "ÊêúÁ¥¢ UID Ê∑ªÂä†Â•ΩÂèã", contact_title: "ËÅîÁ≥ª‰∫∫", group_members: "Áæ§ÊàêÂëò",
            ctx_pin: "ÁΩÆÈ°∂", ctx_unpin: "ÂèñÊ∂àÁΩÆÈ°∂", ctx_mute: "ÂÖçÊâìÊâ∞", ctx_unmute: "ÂºÄÂêØÊèêÈÜí",
            role_owner: "Áæ§‰∏ª", role_admin: "ÁÆ°ÁêÜ", kick: "ÁßªÈô§",
            btn_self: "Ëá™Â∑±", btn_msg: "ÂèëÊ∂àÊÅØ", btn_add: "Âä†Â•ΩÂèã",
            edit_title_prompt: "‰øÆÊîπÁæ§ÂêçÁß∞Ôºö", confirm_kick: "Á°ÆÂÆöË¶ÅÁßªÈô§ËØ•ÊàêÂëòÂêóÔºü",
            group_avatar_updated: "Áæ§Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞", input_uid: "ËæìÂÖ•Áî®Êà∑ UID:"
        },
        id: {
            empty_chat: "Tidak ada obrolan", send_btn: "Kirim", menu_lang: "Bahasa", menu_exit: "Keluar",
            search_placeholder: "Cari UID teman", contact_title: "Kontak", group_members: "Anggota",
            ctx_pin: "Sematkan", ctx_unpin: "Lepas Sematan", ctx_mute: "Bisukan", ctx_unmute: "Bunyikan",
            role_owner: "Pemilik", role_admin: "Admin", kick: "Hapus",
            btn_self: "Anda", btn_msg: "Pesan", btn_add: "Tambah",
            edit_title_prompt: "Ubah Nama Grup:", confirm_kick: "Hapus anggota ini?",
            group_avatar_updated: "Foto grup diperbarui", input_uid: "Masukkan UID:"
        },
        en: {
            empty_chat: "No chat selected", send_btn: "Send", menu_lang: "Language", menu_exit: "Exit",
            search_placeholder: "Search UID", contact_title: "Contacts", group_members: "Members",
            ctx_pin: "Pin", ctx_unpin: "Unpin", ctx_mute: "Mute", ctx_unmute: "Unmute",
            role_owner: "Owner", role_admin: "Admin", kick: "Kick",
            btn_self: "You", btn_msg: "Message", btn_add: "Add",
            edit_title_prompt: "Edit Group Name:", confirm_kick: "Remove this member?",
            group_avatar_updated: "Group avatar updated", input_uid: "Enter UID:"
        }
    };

    let curLang = localStorage.getItem('dreams_lang') || 'zh';
    function setLang(l) {
        curLang = l; localStorage.setItem('dreams_lang', l);
        const t = translations[l];
        // 1. ÈùôÊÄÅÊñáÊú¨
        document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = t[e.dataset.i18n] || e.innerText);
        // 2. Placeholder
        document.querySelectorAll('[data-i18n-placeholder]').forEach(e => e.placeholder = t[e.dataset.i18nPlaceholder]);
        // 3. Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
        hideAllMenus(); refreshConversations(); if(currentCid) loadMembers(currentCid);
    }

    let me, ws, currentCid, currentType, currentRole, ctxCid;

    (async function init() {
        setLang(curLang);
        me = await Dreams.apiMe();
        if (!me) { location.href = "./login.html"; return; }
        document.getElementById("myAvatar").src = me.avatar || `https://ui-avatars.com/api/?background=random&name=${me.username}`;
        await refreshConversations(); await refreshFriends();
        document.getElementById("msgInput").addEventListener("keydown", (e)=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMsg();}});
        document.getElementById("searchUidInput").addEventListener("keydown", (e)=>{if(e.key==="Enter"&&e.target.value.trim())showProfile(e.target.value.trim());});
    })();

    function switchTab(t) {
        document.getElementById("tabChat").classList.toggle("active", t==='chat');
        document.getElementById("tabFriend").classList.toggle("active", t==='friend');
        document.getElementById("panelChat").style.display = t==='chat'?'flex':'none';
        document.getElementById("panelFriend").style.display = t==='friend'?'flex':'none';
    }
    function toggleMenu(e, id) { e.stopPropagation(); const m=document.getElementById(id); m.style.display=m.style.display==='block'?'none':'block'; }
    function hideAllMenus() { document.getElementById("sysMenu").style.display='none'; document.getElementById("ctxMenu").style.display='none'; document.getElementById("langOpts").classList.remove("show"); }
    function toggleLang() { document.getElementById("langOpts").classList.toggle("show"); }
    function changeLang(l) { setLang(l); }

    async function refreshConversations() {
        const res = await Dreams.apiGet("/api/conversations");
        const list = document.getElementById("convList"); list.innerHTML = ""; let totalUnread = 0;
        if(res.items) res.items.forEach(c => {
            const div = document.createElement("div");
            div.className = `session-item ${currentCid===c.id?'active':''} ${c.is_pinned?'pinned':''}`;
            div.onclick = () => switchChat(c);
            div.oncontextmenu = (e) => showCtxMenu(e, c);
            let avatar = c.avatar || (c.type==='group'?"https://ui-avatars.com/api/?background=0099ff&color=fff&name=Group":`https://ui-avatars.com/api/?background=random&name=${c.title}`);
            let badge = "";
            if(c.unread>0) { badge=`<div class="unread-badge">${c.unread>99?'99+':c.unread}</div>`; if(!c.is_muted)totalUnread+=c.unread; }
            div.innerHTML = `<img class="s-avatar" src="${avatar}"><div class="s-content"><div class="s-top"><span class="s-name">${c.title}</span><span class="s-time"></span></div><div class="s-top"><span class="s-msg">${c.last_msg||""}</span><div style="display:flex">${c.is_muted?'<i class="fas fa-bell-slash muted-icon"></i>':''}${badge}</div></div></div>`;
            list.appendChild(div);
        });
        document.getElementById("totalBadge").classList.toggle("show", totalUnread>0);
    }
    async function refreshFriends() {
        const res = await Dreams.apiGet("/api/friends");
        const list = document.getElementById("friendList"); list.innerHTML = "";
        if(res.items) res.items.forEach(u => {
            const div = document.createElement("div"); div.className = "friend-item";
            div.onclick = () => createPrivateChat(u.id);
            div.innerHTML = `<img class="s-avatar" src="${u.avatar||'https://ui-avatars.com/api/?background=random&name='+u.username}"><span class="f-name">${u.username}</span>`;
            list.appendChild(div);
        });
    }

    async function switchChat(c) {
        if(currentCid === c.id) return;
        currentCid = c.id; currentType = c.type; currentRole = c.my_role;
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("chatInterface").style.display = "flex";
        
        const titleEl = document.getElementById("chatTitle");
        titleEl.innerText = c.title;
        if(currentRole === 'owner') { titleEl.classList.add("editable"); titleEl.title="Edit Name"; } else { titleEl.classList.remove("editable"); titleEl.title=""; }
        document.getElementById("btnGroupAvatar").style.display = (currentRole==='owner' && c.type==='group') ? 'block' : 'none';

        refreshConversations();
        if(c.unread>0) { await Dreams.apiPost(`/api/conversations/${c.id}/read`, {}); refreshConversations(); }

        const box = document.getElementById("msgBox"); box.innerHTML = "";
        const msgs = await Dreams.apiGet(`/api/conversations/${c.id}/messages?limit=50`);
        if(msgs.items) msgs.items.forEach(m => appendMessage(m));

        if(ws) ws.close();
        ws = Dreams.connectChat(c.id, (d)=>{ if(d.type==='message'){appendMessage(d);Dreams.apiPost(`/api/conversations/${c.id}/read`,{});} });
        const side = document.getElementById("memberSidebar");
        if(c.type==='group') { side.style.display='flex'; loadMembers(c.id); } else { side.style.display='none'; }
    }

    async function loadMembers(cid) {
        const res = await Dreams.apiGet(`/api/conversations/${cid}/members`);
        const list = document.getElementById("memberList"); list.innerHTML = "";
        document.getElementById("memberCount").innerText = res.items.length;
        const t = translations[curLang];

        const canAdd = (currentRole === 'owner' || currentRole === 'admin');
        document.getElementById("btnAddMember").style.display = canAdd ? 'block' : 'none';

        if(res.items) res.items.forEach(u => {
            const div = document.createElement("div"); div.className = "member-item";
            div.onclick = () => showProfile(u.id);
            
            let badge = "";
            if(u.role==='owner') badge = ` <span class="badge badge-owner">${t.role_owner}</span>`;
            else if(u.role==='admin') badge = ` <span class="badge badge-admin">${t.role_admin}</span>`;

            let kickBtn = "";
            let canKick = false;
            if(currentRole === 'owner' && u.id !== me.uid) canKick = true;
            if(currentRole === 'admin' && u.role === 'member') canKick = true;
            if(canKick) kickBtn = `<span class="btn-kick" onclick="kickMember(event, ${u.id})">${t.kick}</span>`;

            div.innerHTML = `<img class="m-avatar" src="${u.avatar||'https://ui-avatars.com/api/?background=random&name='+u.username}"><span class="m-name">${u.username}</span>${badge}${kickBtn}`;
            list.appendChild(div);
        });
    }

    async function editGroupTitle() {
        if(currentRole !== 'owner') return;
        const t = translations[curLang];
        const newT = prompt(t.edit_title_prompt, document.getElementById("chatTitle").innerText);
        if(newT) { await Dreams.apiPost(`/api/conversations/${currentCid}/update`, {title: newT}); document.getElementById("chatTitle").innerText = newT; refreshConversations(); }
    }
    
    async function uploadGroupAvatar(input) {
        if(!input.files[0]) return;
        const b64 = await Dreams.fileToBase64(input.files[0]);
        await Dreams.apiPost(`/api/conversations/${currentCid}/update`, {avatar: b64});
        alert(translations[curLang].group_avatar_updated); refreshConversations();
    }

    async function kickMember(e, uid) {
        e.stopPropagation();
        if(confirm(translations[curLang].confirm_kick)) {
            const res = await Dreams.apiPost(`/api/conversations/${currentCid}/kick`, {target_uid: uid});
            if(!res.error) loadMembers(currentCid); else alert(res.error);
        }
    }

    // Âè≥ÈîÆÁøªËØëÊîØÊåÅ
    function showCtxMenu(e, c) { 
        e.preventDefault(); ctxCid=c.id; 
        const m=document.getElementById("ctxMenu"); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; 
        const t = translations[curLang];
        document.getElementById("ctxPin").innerText = c.is_pinned ? t.ctx_unpin : t.ctx_pin; 
        document.getElementById("ctxMute").innerText = c.is_muted ? t.ctx_unmute : t.ctx_mute; 
    }

    async function toggleSetting(a) { 
        const t = translations[curLang];
        const el=document.getElementById(a==='pin'?'ctxPin':'ctxMute'); 
        // ÁÆÄÂçïÂà§Êñ≠ÂΩìÂâçÊñáÊú¨ÊòØ‰∏çÊòØ "ÂèñÊ∂à" Êàñ "ÂºÄÂêØ" ÂºÄÂ§¥ (‰∏≠Êñá) Êàñ Un- (Ëã±Êñá)
        const txt = el.innerText;
        const isSet = txt.startsWith("ÂèñÊ∂à") || txt.startsWith("ÂºÄÂêØ") || txt.startsWith("Un") || txt.startsWith("Lepas") || txt.startsWith("Bunyi");
        const act=a==='pin'?(isSet?'unpin':'pin'):(isSet?'unmute':'mute'); 
        await Dreams.apiPost(`/api/conversations/${ctxCid}/setting`,{action:act}); refreshConversations(); 
    }

    async function addGroupMember() { if(currentCid){ const u=prompt(translations[curLang].input_uid); if(u)Dreams.apiPost(`/api/conversations/${currentCid}/members`,{new_uid:u}).then(r=>{if(r.error)alert(r.error);else loadMembers(currentCid)}); } }
    
    // ÈÄöÁî®ÂáΩÊï∞
    function appendMessage(msg) {
        const box = document.getElementById("msgBox"); const isMe = (me && msg.sender_uid === me.uid);
        const div = document.createElement("div"); div.className = isMe ? "msg-row me" : "msg-row";
        let content = Dreams.escapeHtml(msg.content);
        if(msg.content.startsWith("[image]")) { const src = msg.content.replace("[image]",""); content = `<img src="${src}" onclick="downloadImg('${src}')">`; }
        const avatar = msg.sender_avatar || `https://ui-avatars.com/api/?background=random&name=${msg.sender_username}`;
        div.innerHTML = `<img class="msg-avatar" src="${avatar}" onclick="showProfile(${msg.sender_uid})"><div class="msg-bubble-wrap"><div class="msg-name">${msg.sender_username}</div><div class="bubble">${content}</div></div>`;
        box.appendChild(div); box.scrollTop = box.scrollHeight;
    }
    function downloadImg(src) { const a = document.createElement('a'); a.href=src; a.download='img.png'; a.click(); }
    async function sendImage(input) { if(!ws||!input.files[0])return; const b64=await Dreams.fileToBase64(input.files[0]); ws.send(JSON.stringify({content:`[image]${b64}`})); input.value=""; }
    function sendMsg() { const i=document.getElementById("msgInput"); const v=i.value.trim(); if(!v||!ws)return; ws.send(JSON.stringify({content:v})); i.value=""; }
    async function showProfile(uid) {
        const res = await Dreams.apiGet(`/api/users/${uid}/profile`);
        const t = translations[curLang];
        document.getElementById("profileModal").style.display="flex";
        document.getElementById("pName").innerText=res.username; document.getElementById("pUid").innerText="UID: "+res.uid;
        document.getElementById("pAvatar").src=res.avatar||`https://ui-avatars.com/api/?background=random&name=${res.username}`;
        const act=document.getElementById("pAction");
        if(res.is_me) act.innerHTML=`<button class="btn-action" style="background:#ccc">${t.btn_self}</button>`;
        else if(res.is_friend) { act.innerHTML=`<button class="btn-action">${t.btn_msg}</button>`; act.onclick=()=>{closeProfile();createPrivateChat(res.uid);} }
        else { act.innerHTML=`<button class="btn-action">${t.btn_add}</button>`; act.onclick=async()=>{await Dreams.apiPost("/api/friends/add",{friend_uid:res.uid});showProfile(uid);} }
    }
    function closeProfile() { document.getElementById("profileModal").style.display="none"; }
    async function createPrivateChat(uid) { const r=await Dreams.apiPost("/api/conversations/private",{peer_uid:uid}); if(!r.error) {switchTab('chat');refreshConversations();} }
    function createNewChat() { const t=prompt("1=Private, 2=Group"); if(t==='1'){const u=prompt("UID");if(u)createPrivateChat(u);} else if(t==='2'){const n=prompt("Name");if(n)Dreams.apiPost("/api/conversations/group",{title:n}).then(refreshConversations);} }
    function toggleMembers() { const s=document.getElementById("memberSidebar"); s.style.display=s.style.display==='none'?'flex':'none'; }
</script>
</body>
</html>
