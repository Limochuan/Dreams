<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dreams QQ 风格版</title>
  <style>
    /* =================全局重置================= */
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: "Microsoft YaHei", sans-serif; height: 100vh; overflow: hidden; background: #e9e9e9; display: flex; justify-content: center; align-items: center; }
    
    /* =================主窗口容器================= */
    .app-container {
        width: 1200px; height: 800px; background: white;
        border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: flex; overflow: hidden;
    }

    /* ================= 1. 极窄侧边栏 (头像/Tab) ================= */
    .sidebar-nav {
        width: 60px; background: #2e2e2e; color: #999;
        display: flex; flex-direction: column; align-items: center; padding-top: 20px;
    }
    .my-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #555; margin-bottom: 20px; cursor: pointer;}
    .nav-icon { font-size: 20px; margin-bottom: 20px; cursor: pointer; }
    .nav-icon.active { color: #00caef; } /* QQ 蓝 */
    .nav-bottom { margin-top: auto; margin-bottom: 20px; font-size: 20px; cursor: pointer; }

    /* ================= 2. 会话列表栏 ================= */
    .session-list {
        width: 250px; background: #f7f7f7; border-right: 1px solid #e5e5e5;
        display: flex; flex-direction: column;
    }
    .search-bar { padding: 15px; }
    .search-input { width: 100%; padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: #e2e2e2; outline: none; font-size: 12px; }
    
    .list-scroll { flex: 1; overflow-y: auto; }
    /* 隐藏滚动条但保留功能 */
    .list-scroll::-webkit-scrollbar { width: 6px; }
    .list-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    .session-item {
        display: flex; align-items: center; padding: 12px 15px; cursor: pointer;
        transition: background 0.2s; position: relative;
    }
    .session-item:hover { background: #ebebeb; }
    .session-item.active { background: #cce9fc; } /* 选中态 */
    
    .s-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; object-fit: cover;}
    .s-info { flex: 1; overflow: hidden; }
    .s-name { font-size: 14px; color: #333; margin-bottom: 4px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .s-preview { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .s-time { font-size: 12px; color: #bbb; position: absolute; top: 12px; right: 10px; }

    /* ================= 3. 聊天主区域 ================= */
    .chat-stage { flex: 1; display: flex; flex-direction: column; background: #f5f5f5; min-width: 0; }
    
    /* 顶部标题栏 */
    .stage-header {
        height: 60px; border-bottom: 1px solid #e7e7e7; display: flex;
        justify-content: space-between; align-items: center; padding: 0 20px;
        background: #f5f5f5;
    }
    .stage-title { font-size: 18px; font-weight: bold; color: #333; }
    .stage-actions { font-size: 20px; color: #666; cursor: pointer; }

    /* 消息滚动区 */
    .stage-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .stage-messages::-webkit-scrollbar { width: 6px; }
    .stage-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    /* 底部输入区 */
    .stage-input { height: 160px; border-top: 1px solid #e7e7e7; background: #fff; display: flex; flex-direction: column; }
    .toolbar { padding: 8px 15px; display: flex; gap: 15px; color: #666; font-size: 18px; }
    .toolbar i { cursor: pointer; }
    .toolbar i:hover { color: #00caef; }
    
    textarea { flex: 1; border: none; outline: none; resize: none; padding: 0 15px; font-size: 14px; font-family: inherit; }
    
    .send-bar { display: flex; justify-content: flex-end; padding: 10px 15px; }
    .btn-send {
        padding: 6px 20px; background: #00caef; color: white; border: none;
        border-radius: 4px; cursor: pointer; font-size: 14px;
    }
    .btn-send:hover { background: #00b5d6; }

    /* ================= 4. 右侧群成员列表 (QQ风格) ================= */
    .group-members {
        width: 180px; border-left: 1px solid #e7e7e7; background: #fff;
        display: none; /* 默认隐藏，单聊时不显示 */
        flex-direction: column;
    }
    .member-header { padding: 10px 15px; font-size: 12px; color: #666; border-bottom: 1px solid #f0f0f0; }
    .member-list { flex: 1; overflow-y: auto; }
    .member-item { display: flex; align-items: center; padding: 6px 10px; cursor: pointer; }
    .member-item:hover { background: #f5f5f5; }
    .m-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
    .m-name { font-size: 12px; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* 身份标签 */
    .badge { padding: 1px 4px; border-radius: 2px; font-size: 10px; margin-left: 4px; color: white; transform: scale(0.9); }
    .badge-owner { background: #f0ad4e; } /* 橙色群主 */
    .badge-admin { background: #00caef; } /* 蓝色管理员 */

    /* ================= 消息气泡样式 (复用之前的优化) ================= */
    .msg-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .msg-row.me { flex-direction: row-reverse; }
    .msg-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
    .msg-content { max-width: 60%; }
    .msg-name { font-size: 12px; color: #999; margin-bottom: 4px; }
    .msg-row.me .msg-name { text-align: right; }
    .bubble { background: #fff; padding: 10px; border-radius: 8px; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-break: break-all;}
    .msg-row.me .bubble { background: #00caef; color: white; }

    /* 系统消息 */
    .system-msg { text-align: center; color: #aaa; font-size: 12px; margin: 10px 0; }
  </style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<div class="app-container">
    <div class="sidebar-nav">
        <img id="myAvatar" class="my-avatar" src="" title="我的资料">
        <i class="fas fa-comment nav-icon active" title="消息"></i>
        <i class="fas fa-user-friends nav-icon" title="联系人"></i>
        <i class="fas fa-folder nav-icon" title="文件"></i>
        <i class="fas fa-cog nav-bottom" onclick="Dreams.logout()" title="退出"></i>
    </div>

    <div class="session-list">
        <div class="search-bar">
            <input class="search-input" placeholder="搜索">
        </div>
        <div class="list-scroll" id="convList">
            </div>
    </div>

    <div class="chat-stage">
        <div class="stage-header">
            <div class="stage-title" id="chatTitle">Dreams</div>
            <div class="stage-actions">
                <i class="fas fa-ellipsis-h" onclick="toggleMembers()" title="群成员"></i>
            </div>
        </div>
        
        <div class="stage-messages" id="chatBox">
            <div style="text-align:center; margin-top: 50px; color:#ccc;">
                <i class="fas fa-comments" style="font-size: 48px; margin-bottom:10px;"></i><br>
                选择一个会话开始聊天
            </div>
        </div>

        <div class="stage-input" id="inputArea" style="visibility: hidden;">
            <div class="toolbar">
                <i class="far fa-smile" title="表情"></i>
                <i class="far fa-image" title="图片 (开发中)" onclick="alert('图片上传接口已就绪，请对接后端 upload API')"></i>
                <i class="far fa-folder-open" title="文件"></i>
                <i class="fas fa-phone-alt" title="语音通话"></i>
            </div>
            <textarea id="msgInput" placeholder="输入消息..."></textarea>
            <div class="send-bar">
                <button class="btn-send" onclick="sendMsg()">发送 (S)</button>
            </div>
        </div>
    </div>

    <div class="group-members" id="memberSidebar">
        <div class="member-header">群成员 <span id="memberCount">0</span></div>
        <div class="member-list" id="memberListBox">
            </div>
    </div>
</div>

<script src="./app.js"></script>

<script>
    let me = null;
    let ws = null;
    let currentCid = null; // 当前选中的会话 ID
    let currentType = null;

    // 初始化
    (async function init() {
        me = await Dreams.apiMe();
        if (!me) { location.href = "./login.html"; return; }
        
        // 设置我的头像
        if (me.avatar) document.getElementById("myAvatar").src = me.avatar;
        else document.getElementById("myAvatar").src = "https://via.placeholder.com/36?text=ME";

        // 加载会话列表
        await refreshConversations();
        
        // 绑定回车发送
        document.getElementById("msgInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });
    })();

    // 刷新会话列表
    async function refreshConversations() {
        const res = await Dreams.apiGet("/api/conversations");
        const list = document.getElementById("convList");
        list.innerHTML = "";
        
        if (!res.items) return;

        res.items.forEach(c => {
            const div = document.createElement("div");
            div.className = `session-item ${currentCid === c.id ? 'active' : ''}`;
            div.onclick = () => selectConversation(c);
            
            // 简单处理头像
            let avatar = "https://via.placeholder.com/40?text=U";
            if (c.type === 'group') avatar = "https://via.placeholder.com/40/00caef/ffffff?text=群";
            
            // 标题
            const title = c.title || (c.type === 'group' ? `群聊 #${c.id}` : `私聊`);

            div.innerHTML = `
                <img class="s-avatar" src="${avatar}">
                <div class="s-info">
                    <div class="s-name">${title}</div>
                    <div class="s-preview">点击查看消息...</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // 选中一个会话
    async function selectConversation(c) {
        if (currentCid === c.id) return;
        currentCid = c.id;
        currentType = c.type;

        // 1. 更新 UI 选中态
        document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
        // (这里为了简便没重新渲染列表，实际开发可以优化 dom 操作)
        refreshConversations();

        // 2. 更新标题和输入框可见性
        document.getElementById("chatTitle").innerText = c.title || "聊天中";
        document.getElementById("inputArea").style.visibility = "visible";
        document.getElementById("chatBox").innerHTML = ""; // 清空消息

        // 3. 加载历史消息
        await loadMessages(c.id);

        // 4. 连接 WebSocket
        startWebSocket(c.id);

        // 5. 如果是群聊，加载成员列表
        const memberSidebar = document.getElementById("memberSidebar");
        if (c.type === 'group') {
            memberSidebar.style.display = "flex";
            loadMembers(c.id);
        } else {
            memberSidebar.style.display = "none";
        }
    }

    // 加载历史消息
    async function loadMessages(cid) {
        const res = await Dreams.apiGet(`/api/conversations/${cid}/messages?limit=50`);
        if (res.items) {
            res.items.forEach(msg => appendMessage(msg));
        }
    }

    // 加载群成员 (使用新接口)
    async function loadMembers(cid) {
        const res = await Dreams.apiGet(`/api/conversations/${cid}/members`);
        const box = document.getElementById("memberListBox");
        box.innerHTML = "";
        
        if (res.items) {
            document.getElementById("memberCount").innerText = res.items.length;
            res.items.forEach(u => {
                const div = document.createElement("div");
                div.className = "member-item";
                
                // 徽章逻辑
                let badgeHtml = "";
                if (u.role === 'owner') badgeHtml = `<span class="badge badge-owner">群主</span>`;
                else if (u.role === 'admin') badgeHtml = `<span class="badge badge-admin">管理</span>`;

                const avatar = u.avatar || `https://via.placeholder.com/24?text=${u.username.charAt(0)}`;

                div.innerHTML = `
                    <img class="m-avatar" src="${avatar}">
                    <div class="m-name">${u.username}</div>
                    ${badgeHtml}
                `;
                box.appendChild(div);
            });
        }
    }

    // WebSocket 连接
    function startWebSocket(cid) {
        if (ws) ws.close(); // 切换会话时关闭旧连接
        ws = Dreams.connectChat(cid, (data) => {
            if (data.type === 'message') appendMessage(data);
            if (data.type === 'system') appendSystem(data);
        });
    }

    // 渲染消息
    function appendMessage(msg) {
        const box = document.getElementById("chatBox");
        const isMe = (me && msg.sender_uid === me.uid);
        
        const div = document.createElement("div");
        div.className = isMe ? "msg-row me" : "msg-row";
        
        const avatar = msg.sender_avatar || `https://via.placeholder.com/36?text=${(msg.sender_username||'U').charAt(0)}`;
        const name = msg.sender_username || `UID ${msg.sender_uid}`;

        div.innerHTML = `
            <img class="msg-avatar" src="${avatar}">
            <div class="msg-content">
                <div class="msg-name">${name}</div>
                <div class="bubble">${Dreams.escapeHtml(msg.content)}</div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function appendSystem(msg) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = "system-msg";
        div.innerText = msg.event;
        box.appendChild(div);
    }

    // 发送消息
    function sendMsg() {
        const input = document.getElementById("msgInput");
        const text = input.value.trim();
        if (!text || !ws) return;
        
        ws.send(JSON.stringify({ content: text }));
        input.value = "";
    }

    // 切换右侧栏显示
    function toggleMembers() {
        const bar = document.getElementById("memberSidebar");
        if (currentType === 'group') {
            bar.style.display = bar.style.display === 'none' ? 'flex' : 'none';
        }
    }
</script>
</body>
</html>
