<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dreams</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ================= Âü∫Á°ÄÊ†∑Âºè ================= */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; background: #e6e6e6;
      font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden;
    }
    .app-window {
        width: 1300px; height: 850px; background: #fff; border-radius: 8px;
        box-shadow: 0 0 20px rgba(0,0,0,0.15); display: flex; overflow: hidden; position: relative;
    }

    /* ================= Â∑¶‰æßÂØºËà™ ================= */
    .sidebar-nav {
        width: 68px; background: #2e2e2e; display: flex; flex-direction: column; align-items: center;
        padding-top: 30px; color: #9d9d9d; position: relative;
    }
    .my-avatar {
        width: 40px; height: 40px; border-radius: 50%; margin-bottom: 25px;
        cursor: pointer; border: 2px solid transparent; transition: border 0.2s;
    }
    .my-avatar:hover { border-color: #fff; }
    .nav-item { font-size: 24px; margin-bottom: 25px; cursor: pointer; transition: color 0.2s; }
    .nav-item:hover { color: #fff; }
    .nav-item.active { color: #0099ff; }
    .nav-bottom { margin-top: auto; margin-bottom: 20px; font-size: 20px; }

    /* ‚ú® Â∑¶‰∏ãËßíÂºπÂá∫ËèúÂçï */
    .context-menu {
        display: none; position: absolute; bottom: 20px; left: 60px;
        width: 160px; background: white; border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 3000; overflow: hidden;
        animation: fadeIn 0.2s ease;
    }
    .menu-item {
        padding: 12px 20px; font-size: 14px; color: #333; cursor: pointer;
        display: flex; align-items: center; gap: 10px;
    }
    .menu-item:hover { background: #f5f5f5; color: #0099ff; }
    .menu-divider { height: 1px; background: #eee; margin: 4px 0; }
    /* ËØ≠Ë®ÄÂ≠êËèúÂçï */
    .lang-options { display: none; background: #f9f9f9; }
    .lang-options.show { display: block; }
    .lang-item { padding: 8px 35px; font-size: 13px; color: #666; cursor: pointer; }
    .lang-item:hover { color: #0099ff; background: #eee; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ================= ÂàóË°® & ÊêúÁ¥¢ ================= */
    .sidebar-list { width: 300px; background: #fdfdfd; border-right: 1px solid #e7e7e7; display: flex; flex-direction: column; }
    .search-box { padding: 20px 15px; background: #f7f7f7; display: flex; align-items: center; justify-content: space-between; }
    .search-input-wrap { position: relative; flex: 1; margin-right: 10px; }
    .search-input { width: 100%; padding: 8px 10px 8px 30px; border: 1px solid #e0e0e0; background: #e9e9e9; border-radius: 4px; outline: none; font-size: 13px; }
    .search-input:focus { background: #fff; border-color: #0099ff; }
    .search-icon { position: absolute; left: 10px; top: 9px; color: #999; font-size: 12px; }
    .btn-create { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #e9e9e9; border-radius: 4px; cursor: pointer; color: #666;}
    .btn-create:hover { background: #dcdcdc; }
    .session-scroll { flex: 1; overflow-y: auto; }
    .session-item { display: flex; padding: 12px 15px; cursor: pointer; transition: background 0.1s; }
    .session-item:hover { background: #f2f2f2; }
    .session-item.active { background: #e5f5ff; }
    .s-avatar { width: 44px; height: 44px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
    .s-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
    .s-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .s-name { font-size: 14px; color: #000; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px;}
    .s-msg { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ================= ËÅäÂ§©Âå∫Âüü ================= */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #f5f5f5; min-width: 0; }
    .chat-header { height: 60px; border-bottom: 1px solid #e7e7e7; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; background: #f5f5f5; }
    .chat-title { font-size: 18px; font-weight: bold; color: #000; }
    .header-icons { display: flex; gap: 20px; color: #333; font-size: 18px; cursor: pointer; }
    .messages-box { flex: 1; overflow-y: auto; padding: 20px 30px; display: flex; flex-direction: column; gap: 20px; }
    
    .msg-row { display: flex; align-items: flex-start; gap: 12px; }
    .msg-row.me { flex-direction: row-reverse; }
    .msg-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
    .msg-bubble-wrap { max-width: 60%; display: flex; flex-direction: column; }
    .msg-name { font-size: 12px; color: #999; margin-bottom: 4px; }
    .msg-row.me .msg-name { display: none; }
    .bubble { padding: 10px 14px; background: #fff; border-radius: 10px; font-size: 14px; line-height: 1.6; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-break: break-word; }
    .msg-row.me .bubble { background: #0099ff; color: #fff; border-top-right-radius: 2px; }
    .msg-row:not(.me) .bubble { border-top-left-radius: 2px; }
    
    /* ‚ú® ÂõæÁâáÊ∂àÊÅØÊ†∑Âºè‰ºòÂåñ */
    .bubble-img { padding: 5px !important; background: transparent !important; box-shadow: none !important; }
    .chat-img { max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
    .chat-img:hover { transform: scale(1.02); opacity: 0.9; }

    /* ËæìÂÖ•Ê°Ü */
    .input-box { height: 180px; border-top: 1px solid #e7e7e7; background: #fff; display: flex; flex-direction: column; }
    .toolbar { padding: 10px 20px; display: flex; gap: 20px; color: #666; font-size: 18px; }
    .tool-icon { cursor: pointer; transition: color 0.2s; }
    .tool-icon:hover { color: #0099ff; }
    textarea { flex: 1; border: none; outline: none; padding: 0 20px; font-size: 14px; font-family: inherit; resize: none; }
    .send-area { padding: 10px 20px 20px; display: flex; justify-content: flex-end; }
    .btn-send { padding: 6px 25px; background: #0099ff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }

    /* ================= Âè≥‰æßÊàêÂëò ================= */
    .member-sidebar { width: 200px; background: #fff; border-left: 1px solid #e7e7e7; display: none; flex-direction: column; }
    .member-header { height: 50px; border-bottom: 1px solid #f0f0f0; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #666; }
    .member-scroll { flex: 1; overflow-y: auto; padding: 5px 0; }
    .member-item { display: flex; align-items: center; padding: 8px 15px; cursor: pointer; }
    .member-item:hover { background: #f5f5f5; }
    .m-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
    .m-name { font-size: 12px; color: #333; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .badge { font-size: 10px; padding: 1px 4px; border-radius: 2px; color: #fff; margin-left: 5px; transform: scale(0.9); }
    .badge-owner { background: #f0ad4e; } .badge-admin { background: #5bc0de; }
    .btn-add-member { cursor: pointer; font-size: 14px; color: #0099ff; }

    /* Á©∫Áä∂ÊÄÅ */
    .empty-state { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #ccc; }
    .empty-icon { font-size: 60px; margin-bottom: 20px; color: #e0e0e0; }

    /* ËµÑÊñôÂç° */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; justify-content: center; align-items: center; }
    .profile-card { background: white; width: 340px; border-radius: 12px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.3); position: relative; }
    .p-banner { height: 100px; background: linear-gradient(135deg, #00c6ff, #0072ff); }
    .p-close { position: absolute; top: 10px; right: 15px; color: #fff; cursor: pointer; font-size: 20px; }
    .p-avatar-wrap { position: absolute; top: 60px; left: 20px; padding: 4px; background: white; border-radius: 50%; }
    .p-avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; background: #eee;}
    .p-info { padding: 45px 20px 20px; }
    .p-name { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
    .p-row { font-size: 14px; color: #666; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;}
    .gender-icon { padding: 2px 8px; border-radius: 4px; font-size: 12px; color: white; }
    .g-male { background: #3c9cfe; } .g-female { background: #ff5ca0; } .g-secret { background: #aaa; }
    .btn-action { width: 100%; padding: 10px; border: none; border-radius: 6px; background: #0099ff; color: white; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

<div class="app-window" onclick="hideMenu()">
    <div class="sidebar-nav">
        <img id="myAvatar" class="my-avatar" src="" onclick="showProfile(me.uid)">
        <i class="fas fa-comment-dots nav-item active" title="‰ºöËØù"></i>
        <i class="fas fa-user-friends nav-item" title="ËÅîÁ≥ª‰∫∫"></i>
        <div class="nav-bottom">
            <i class="fas fa-bars nav-item" id="menuBtn" onclick="toggleMenu(event)"></i>
        </div>
        
        <div class="context-menu" id="sysMenu" onclick="event.stopPropagation()">
            <div class="menu-item" onclick="toggleLang()">
                <i class="fas fa-globe"></i> <span data-i18n="menu_lang">ËØ≠Ë®Ä</span>
                <i class="fas fa-chevron-right" style="margin-left:auto; font-size:10px;"></i>
            </div>
            <div class="lang-options" id="langOpts">
                <div class="lang-item" onclick="changeLang('zh')">üá®üá≥ ‰∏≠Êñá</div>
                <div class="lang-item" onclick="changeLang('id')">üáÆüá© Indonesia</div>
                <div class="lang-item" onclick="changeLang('en')">üá∫üá∏ English</div>
            </div>

            <div class="menu-divider"></div>
            
            <div class="menu-item" onclick="switchAccount()">
                <i class="fas fa-exchange-alt"></i> <span data-i18n="menu_switch">ÂàáÊç¢Ë¥¶Âè∑</span>
            </div>
            <div class="menu-item" onclick="logout()" style="color:#ff4d4f">
                <i class="fas fa-sign-out-alt"></i> <span data-i18n="menu_exit">ÈÄÄÂá∫</span>
            </div>
        </div>
    </div>

    <div class="sidebar-list">
        <div class="search-box">
            <div class="search-input-wrap">
                <i class="fas fa-search search-icon"></i>
                <input class="search-input" id="searchUidInput" data-i18n-placeholder="search_placeholder" placeholder="ÊêúÁ¥¢ UID Ê∑ªÂä†Â•ΩÂèã">
            </div>
            <div class="btn-create" onclick="createNewChat()" title="Create Chat"><i class="fas fa-plus"></i></div>
        </div>
        <div class="session-scroll" id="convList"></div>
    </div>

    <div class="chat-area">
        <div id="emptyState" class="empty-state">
            <i class="fas fa-comments empty-icon"></i>
            <div data-i18n="empty_chat">Êú™ÈÄâÊã©‰ºöËØù</div>
        </div>

        <div id="chatInterface" style="display: none; height: 100%; flex-direction: column;">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle"></div>
                <div class="header-icons">
                    <i class="fas fa-ellipsis-h tool-icon" onclick="toggleMembers()"></i>
                </div>
            </div>

            <div class="messages-box" id="msgBox"></div>

            <div class="input-box">
                <div class="toolbar">
                    <i class="far fa-smile tool-icon"></i>
                    <label for="imgInput" style="cursor:pointer">
                        <i class="far fa-image tool-icon" title="Image"></i>
                    </label>
                    <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="sendImage(this)">
                </div>
                <textarea id="msgInput"></textarea>
                <div class="send-area">
                    <button class="btn-send" onclick="sendMsg()" data-i18n="send_btn">ÂèëÈÄÅ(S)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="member-sidebar" id="memberSidebar">
        <div class="member-header">
            <span><span data-i18n="group_members">Áæ§ÊàêÂëò</span> (<span id="memberCount">0</span>)</span>
            <i class="fas fa-user-plus btn-add-member" onclick="addGroupMember()"></i>
        </div>
        <div class="member-scroll" id="memberList"></div>
    </div>
</div>

<div id="profileModal" class="modal-overlay" onclick="closeProfile()">
    <div class="profile-card" onclick="event.stopPropagation()">
        <div class="p-banner"></div>
        <div class="p-close" onclick="closeProfile()">√ó</div>
        <div class="p-avatar-wrap"><img id="pAvatar" class="p-avatar"></div>
        <div class="p-info">
            <div class="p-name" id="pName"></div>
            <div class="p-row">
                <span id="pGender" class="gender-icon"></span>
                <span id="pUid" style="font-family:monospace"></span>
            </div>
            <div class="p-row"><span data-i18n="reg_date">Ê≥®ÂÜå‰∫é</span>: <span id="pDate"></span></div>
            <div class="p-action" id="pAction"></div>
        </div>
    </div>
</div>

<script src="./app.js"></script>
<script>
    /* ================= ÂõΩÈôÖÂåñÈÖçÁΩÆ ================= */
    const translations = {
        zh: {
            search_placeholder: "ÊêúÁ¥¢ UID Ê∑ªÂä†Â•ΩÂèã",
            empty_chat: "Êú™ÈÄâÊã©‰ºöËØù",
            send_btn: "ÂèëÈÄÅ(S)",
            group_members: "Áæ§ÊàêÂëò",
            reg_date: "Ê≥®ÂÜå‰∫é",
            menu_lang: "ËØ≠Ë®Ä",
            menu_switch: "ÂàáÊç¢Ë¥¶Âè∑",
            menu_exit: "ÈÄÄÂá∫",
            role_owner: "Áæ§‰∏ª",
            role_admin: "ÁÆ°ÁêÜ",
            is_me: "ËøôÊòØ‰Ω†Ëá™Â∑±",
            btn_msg: "ÂèëÊ∂àÊÅØ",
            btn_add: "Âä†‰∏∫Â•ΩÂèã",
            group_chat: "Áæ§ËÅä",
            private_chat: "ÁßÅËÅä"
        },
        id: {
            search_placeholder: "Cari UID untuk tambah teman",
            empty_chat: "Tidak ada obrolan dipilih",
            send_btn: "Kirim(S)",
            group_members: "Anggota",
            reg_date: "Terdaftar",
            menu_lang: "Bahasa",
            menu_switch: "Ganti Akun",
            menu_exit: "Keluar",
            role_owner: "Pemilik",
            role_admin: "Admin",
            is_me: "Ini Anda",
            btn_msg: "Kirim Pesan",
            btn_add: "Tambah Teman",
            group_chat: "Grup",
            private_chat: "Pribadi"
        },
        en: {
            search_placeholder: "Search UID to add friend",
            empty_chat: "No chat selected",
            send_btn: "Send(S)",
            group_members: "Members",
            reg_date: "Joined",
            menu_lang: "Language",
            menu_switch: "Switch Account",
            menu_exit: "Exit",
            role_owner: "Owner",
            role_admin: "Admin",
            is_me: "It's You",
            btn_msg: "Message",
            btn_add: "Add Friend",
            group_chat: "Group",
            private_chat: "Private"
        }
    };

    let curLang = localStorage.getItem('dreams_lang') || 'zh';

    function setLang(lang) {
        curLang = lang;
        localStorage.setItem('dreams_lang', lang);
        const t = translations[lang];

        // Êõ¥Êñ∞ÊôÆÈÄöÊñáÊú¨
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(t[key]) el.innerText = t[key];
        });
        // Êõ¥Êñ∞ Placeholder
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if(t[key]) el.placeholder = t[key];
        });
        
        // Âà∑Êñ∞ÂàóË°®‰ª•Êõ¥Êñ∞Âä®ÊÄÅÊñáÂ≠ó
        refreshConversations();
        hideMenu();
    }

    /* ================= ‰∏öÂä°ÈÄªËæë ================= */
    let me = null;
    let ws = null;
    let currentCid = null;
    let currentType = null;

    (async function init() {
        setLang(curLang); // ÂàùÂßãÂåñËØ≠Ë®Ä
        me = await Dreams.apiMe();
        if (!me) { location.href = "./login.html"; return; }
        
        document.getElementById("myAvatar").src = me.avatar || `https://ui-avatars.com/api/?background=random&name=${me.username}`;
        await refreshConversations();
        
        document.getElementById("msgInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMsg(); }
        });
        document.getElementById("searchUidInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter") { const uid = e.target.value.trim(); if (uid) showProfile(uid); }
        });
    })();

    // ËèúÂçïÊìç‰Ωú
    function toggleMenu(e) { e.stopPropagation(); const m = document.getElementById("sysMenu"); m.style.display = m.style.display==='block'?'none':'block'; }
    function hideMenu() { document.getElementById("sysMenu").style.display = 'none'; document.getElementById("langOpts").classList.remove("show"); }
    function toggleLang() { document.getElementById("langOpts").classList.toggle("show"); }
    function changeLang(l) { setLang(l); }
    function logout() { Dreams.logout(); }
    function switchAccount() { Dreams.logout(); }

    async function refreshConversations() {
        const res = await Dreams.apiGet("/api/conversations");
        const list = document.getElementById("convList");
        list.innerHTML = "";
        const t = translations[curLang];
        if (res.items) {
            res.items.forEach(c => {
                const div = document.createElement("div");
                div.className = `session-item ${currentCid === c.id ? 'active' : ''}`;
                div.onclick = () => switchChat(c);
                let avatar = c.type === 'group' ? "https://ui-avatars.com/api/?background=0099ff&color=fff&name=Group" : "https://ui-avatars.com/api/?background=random&name=User";
                const typeName = c.type === 'group' ? t.group_chat : t.private_chat;
                const title = c.title || `${typeName} #${c.id}`;
                div.innerHTML = `<img class="s-avatar" src="${avatar}"><div class="s-content"><div class="s-top"><span class="s-name">${title}</span></div><div class="s-msg">...</div></div>`;
                list.appendChild(div);
            });
        }
    }

    async function switchChat(c) {
        if (currentCid === c.id) return;
        currentCid = c.id;
        currentType = c.type;
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("chatInterface").style.display = "flex";
        const t = translations[curLang];
        const typeName = c.type === 'group' ? t.group_chat : t.private_chat;
        document.getElementById("chatTitle").innerText = c.title || `${typeName} #${c.id}`;
        
        document.querySelectorAll(".session-item").forEach(el => el.classList.remove("active"));
        refreshConversations();

        const box = document.getElementById("msgBox");
        box.innerHTML = "";
        const msgs = await Dreams.apiGet(`/api/conversations/${c.id}/messages?limit=50`);
        if (msgs.items) msgs.items.forEach(m => appendMessage(m));
        
        if (ws) ws.close();
        ws = Dreams.connectChat(c.id, (data) => { if (data.type === 'message') appendMessage(data); });

        const side = document.getElementById("memberSidebar");
        if (c.type === 'group') { side.style.display = "flex"; loadMembers(c.id); } 
        else { side.style.display = "none"; }
    }

    async function loadMembers(cid) {
        const res = await Dreams.apiGet(`/api/conversations/${cid}/members`);
        const list = document.getElementById("memberList");
        list.innerHTML = "";
        const t = translations[curLang];
        if (res.items) {
            document.getElementById("memberCount").innerText = res.items.length;
            res.items.forEach(u => {
                const div = document.createElement("div");
                div.className = "member-item";
                let badge = "";
                if (u.role === 'owner') badge = `<span class="badge badge-owner">${t.role_owner}</span>`;
                else if (u.role === 'admin') badge = `<span class="badge badge-admin">${t.role_admin}</span>`;
                const avatar = u.avatar || `https://ui-avatars.com/api/?background=random&name=${u.username}`;
                div.onclick = () => showProfile(u.id);
                div.innerHTML = `<img class="m-avatar" src="${avatar}"><span class="m-name">${u.username}</span>${badge}`;
                list.appendChild(div);
            });
        }
    }

    async function addGroupMember() {
        if (currentType !== 'group') return;
        const uid = prompt("UID:");
        if (uid) {
            const res = await Dreams.apiPost(`/api/conversations/${currentCid}/members`, { new_uid: uid });
            if (res.error) alert(res.error); else { loadMembers(currentCid); }
        }
    }

    async function sendImage(input) {
        if (!ws || !input.files[0]) return;
        const base64 = await Dreams.fileToBase64(input.files[0]);
        ws.send(JSON.stringify({ content: `[image]${base64}` }));
        input.value = "";
    }

    // ‚ú® ÂõæÁâá‰∏ãËΩΩÂäüËÉΩ
    function downloadImage(base64Data, filename) {
        const a = document.createElement('a');
        a.href = base64Data;
        a.download = filename || 'image.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function appendMessage(msg) {
        const box = document.getElementById("msgBox");
        const isMe = (me && msg.sender_uid === me.uid);
        const div = document.createElement("div");
        div.className = isMe ? "msg-row me" : "msg-row";
        
        let contentHtml = "";
        let bubbleClass = "bubble";
        
        if (msg.content.startsWith("[image]data:image")) {
            const src = msg.content.replace("[image]", "");
            // ‚ú® ÁÇπÂáªÂõæÁâáËß¶Âèë‰∏ãËΩΩ
            contentHtml = `<img src="${src}" class="chat-img" onclick="downloadImage('${src}', 'dreams_img_${Date.now()}.png')">`;
            bubbleClass += " bubble-img"; 
        } else {
            contentHtml = Dreams.escapeHtml(msg.content);
        }
        
        const avatar = msg.sender_avatar || `https://ui-avatars.com/api/?background=random&name=${msg.sender_username}`;
        const avatarHtml = `<img class="msg-avatar" src="${avatar}" onclick="showProfile(${msg.sender_uid})">`;

        div.innerHTML = `${avatarHtml}<div class="msg-bubble-wrap"><div class="msg-name">${msg.sender_username}</div><div class="${bubbleClass}">${contentHtml}</div></div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMsg() {
        const input = document.getElementById("msgInput");
        const val = input.value.trim();
        if (!val || !ws) return;
        ws.send(JSON.stringify({ content: val }));
        input.value = "";
    }

    async function showProfile(uid) {
        const res = await Dreams.apiGet(`/api/users/${uid}/profile`);
        if (res.error) { alert("Not Found"); return; }
        const t = translations[curLang];
        document.getElementById("profileModal").style.display = "flex";
        document.getElementById("pName").innerText = res.username;
        document.getElementById("pUid").innerText = "UID: " + res.uid;
        document.getElementById("pDate").innerText = res.created_at;
        document.getElementById("pAvatar").src = res.avatar || `https://ui-avatars.com/api/?background=random&name=${res.username}`;
        
        const gMap = { 'male': '‚ôÇ', 'female': '‚ôÄ', 'secret': '„äô' };
        const gClass = { 'male': 'g-male', 'female': 'g-female', 'secret': 'g-secret' };
        const gSpan = document.getElementById("pGender");
        gSpan.innerText = gMap[res.gender];
        gSpan.className = "gender-icon " + gClass[res.gender];

        const actDiv = document.getElementById("pAction");
        actDiv.innerHTML = "";
        
        if (res.is_me) {
            actDiv.innerHTML = `<button class="btn-action" style="background:#ccc">${t.is_me}</button>`;
        } else if (res.is_friend) {
            actDiv.innerHTML = `<button class="btn-action">${t.btn_msg}</button>`;
            actDiv.onclick = () => { closeProfile(); createPrivateChat(res.uid); };
        } else {
            actDiv.innerHTML = `<button class="btn-action">${t.btn_add}</button>`;
            actDiv.onclick = () => addFriend(res.uid);
        }
    }

    async function addFriend(uid) { await Dreams.apiPost("/api/friends/add", { friend_uid: uid }); alert("Added!"); showProfile(uid); }
    async function createPrivateChat(uid) { const res = await Dreams.apiPost("/api/conversations/private", { peer_uid: uid }); if (!res.error) refreshConversations(); }
    function createNewChat() { 
        const type = prompt("Type (1=Private, 2=Group):"); 
        if (type==='1') { const u=prompt("UID:"); if(u) createPrivateChat(u); }
        else if (type==='2') { const t=prompt("Name:"); if(t) Dreams.apiPost("/api/conversations/group", { title:t }).then(refreshConversations); }
    }
    function closeProfile() { document.getElementById("profileModal").style.display = "none"; }
    function toggleMembers() { if (currentType !== 'group') return; const s = document.getElementById("memberSidebar"); s.style.display = s.style.display === 'none' ? 'flex' : 'none'; }
</script>
</body>
</html>
