<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dreams</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ================= 基础重置 ================= */
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      background: #e6e6e6; /* 桌面背景色 */
      font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    /* ================= 主窗口容器 ================= */
    .app-window {
        width: 1300px; height: 850px;
        background: #fff;
        border-radius: 8px; /* 稍微小一点的圆角，更像原生窗口 */
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
        display: flex;
        overflow: hidden;
        position: relative;
    }

    /* ================= 1. 极左侧边栏 (功能导航) ================= */
    .sidebar-nav {
        width: 68px; background: #2e2e2e;
        display: flex; flex-direction: column; align-items: center;
        padding-top: 30px; color: #9d9d9d;
    }
    .my-avatar {
        width: 40px; height: 40px; border-radius: 50%;
        margin-bottom: 25px; border: 2px solid transparent; cursor: pointer;
        transition: border 0.2s;
    }
    .my-avatar:hover { border-color: #fff; }
    
    .nav-item { font-size: 24px; margin-bottom: 25px; cursor: pointer; transition: color 0.2s; }
    .nav-item:hover { color: #fff; }
    .nav-item.active { color: #0099ff; } /* QQ 蓝 */
    
    .nav-bottom { margin-top: auto; margin-bottom: 20px; font-size: 20px; }

    /* ================= 2. 会话列表栏 ================= */
    .sidebar-list {
        width: 300px; background: #fdfdfd; border-right: 1px solid #e7e7e7;
        display: flex; flex-direction: column;
    }
    
    /* 搜索框 */
    .search-box {
        padding: 20px 15px; background: #f7f7f7;
        display: flex; align-items: center; justify-content: space-between;
    }
    .search-input-wrap {
        position: relative; flex: 1; margin-right: 10px;
    }
    .search-input {
        width: 100%; padding: 8px 10px 8px 30px; border: 1px solid #e0e0e0;
        background: #e9e9e9; border-radius: 4px; outline: none; font-size: 13px;
        transition: all 0.2s;
    }
    .search-input:focus { background: #fff; border-color: #0099ff; }
    .search-icon { position: absolute; left: 10px; top: 9px; color: #999; font-size: 12px; }
    .btn-add { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #e9e9e9; border-radius: 4px; cursor: pointer; color: #666;}
    .btn-add:hover { background: #dcdcdc; }

    /* 列表滚动区 */
    .session-scroll { flex: 1; overflow-y: auto; }
    .session-scroll::-webkit-scrollbar { width: 6px; }
    .session-scroll::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 3px; }

    .session-item {
        display: flex; padding: 12px 15px; cursor: pointer; position: relative;
        transition: background 0.1s;
    }
    .session-item:hover { background: #f2f2f2; }
    .session-item.active { background: #e5f5ff; } /* 选中淡蓝背景 */
    
    .s-avatar { width: 44px; height: 44px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
    .s-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
    .s-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .s-name { font-size: 14px; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
    .s-time { font-size: 12px; color: #b2b2b2; }
    .s-msg { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ================= 3. 中间聊天区域 ================= */
    .chat-area {
        flex: 1; display: flex; flex-direction: column; background: #f5f5f5; min-width: 0;
    }
    
    /* 聊天标题栏 */
    .chat-header {
        height: 60px; border-bottom: 1px solid #e7e7e7;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 25px; background: #f5f5f5;
        -webkit-app-region: drag; /* 如果做成 Electron 应用可拖拽 */
    }
    .chat-title { font-size: 18px; font-weight: bold; color: #000; display: flex; align-items: center; gap: 8px;}
    .status-dot { width: 10px; height: 10px; background: #1eba0c; border-radius: 50%; } /* 在线绿点 */
    .header-icons { display: flex; gap: 20px; color: #333; font-size: 18px; cursor: pointer; }
    
    /* 消息展示区 */
    .messages-box {
        flex: 1; overflow-y: auto; padding: 20px 30px;
        display: flex; flex-direction: column; gap: 20px;
    }
    .messages-box::-webkit-scrollbar { width: 8px; }
    .messages-box::-webkit-scrollbar-thumb { background: #dcdcdc; border-radius: 4px; }

    /* 消息气泡样式 */
    .msg-row { display: flex; align-items: flex-start; gap: 12px; }
    .msg-row.me { flex-direction: row-reverse; }
    .msg-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
    .msg-bubble-wrap { max-width: 60%; display: flex; flex-direction: column; }
    .msg-name { font-size: 12px; color: #999; margin-bottom: 4px; }
    .msg-row.me .msg-name { text-align: right; display: none; } /* 自己不显示名字 */
    
    .bubble {
        padding: 10px 14px; background: #fff; border-radius: 10px;
        font-size: 14px; line-height: 1.6; color: #000;
        position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        word-break: break-word;
    }
    .msg-row.me .bubble {
        background: #0099ff; color: #fff; /* QQ 蓝 */
        border-top-right-radius: 2px;
    }
    .msg-row:not(.me) .bubble { border-top-left-radius: 2px; }

    /* 输入框区域 */
    .input-box {
        height: 180px; border-top: 1px solid #e7e7e7; background: #fff;
        display: flex; flex-direction: column;
    }
    .toolbar {
        padding: 10px 20px; display: flex; gap: 20px; color: #666; font-size: 18px;
    }
    .tool-icon { cursor: pointer; transition: color 0.2s; }
    .tool-icon:hover { color: #0099ff; }
    
    textarea {
        flex: 1; border: none; outline: none; padding: 0 20px;
        font-size: 14px; font-family: inherit; resize: none;
    }
    .send-area {
        padding: 10px 20px 20px; display: flex; justify-content: flex-end;
    }
    .btn-send {
        padding: 6px 25px; background: #0099ff; color: #fff; border: none;
        border-radius: 4px; cursor: pointer; font-size: 14px;
        transition: background 0.2s;
    }
    .btn-send:hover { background: #007acc; }

    /* ================= 4. 右侧成员列表 ================= */
    .member-sidebar {
        width: 200px; background: #fff; border-left: 1px solid #e7e7e7;
        display: none; /* 默认隐藏 */
        flex-direction: column;
    }
    .member-header {
        height: 50px; border-bottom: 1px solid #f0f0f0; padding: 0 15px;
        display: flex; align-items: center; font-size: 12px; color: #666;
    }
    .member-scroll { flex: 1; overflow-y: auto; padding: 5px 0; }
    
    .member-item {
        display: flex; align-items: center; padding: 8px 15px; cursor: pointer;
    }
    .member-item:hover { background: #f5f5f5; }
    .m-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; }
    .m-name { font-size: 12px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;}
    
    /* 身份标签 */
    .badge {
        font-size: 10px; padding: 1px 4px; border-radius: 2px;
        color: #fff; margin-left: 5px; transform: scale(0.9);
    }
    .badge-owner { background: #f0ad4e; }
    .badge-admin { background: #5bc0de; }

    /* 欢迎页空状态 */
    .empty-state {
        flex: 1; display: flex; flex-direction: column;
        justify-content: center; align-items: center; color: #ccc;
    }
    .empty-icon { font-size: 60px; margin-bottom: 20px; color: #e0e0e0; }
  </style>
</head>
<body>

<div class="app-window">
    <div class="sidebar-nav">
        <img id="myAvatar" class="my-avatar" src="" title="个人资料">
        <i class="fas fa-comment-dots nav-item active" title="会话"></i>
        <i class="fas fa-user-friends nav-item" title="好友"></i>
        <i class="fas fa-box-archive nav-item" title="收藏"></i>
        <div class="nav-bottom">
            <i class="fas fa-bars nav-item" title="菜单"></i>
        </div>
    </div>

    <div class="sidebar-list">
        <div class="search-box">
            <div class="search-input-wrap">
                <i class="fas fa-search search-icon"></i>
                <input class="search-input" placeholder="搜索">
            </div>
            <div class="btn-add" onclick="createNewChat()" title="发起聊天"><i class="fas fa-plus"></i></div>
        </div>
        <div class="session-scroll" id="convList">
            </div>
    </div>

    <div class="chat-area">
        <div id="emptyState" class="empty-state">
            <i class="fab fa-qq empty-icon"></i>
            <div>暂无选中会话</div>
        </div>

        <div id="chatInterface" style="display: none; height: 100%; flex-direction: column;">
            <div class="chat-header">
                <div class="chat-title">
                    <span id="chatTitle">群聊名称</span>
                    </div>
                <div class="header-icons">
                    <i class="fas fa-phone-alt tool-icon" title="语音通话"></i>
                    <i class="fas fa-video tool-icon" title="视频通话"></i>
                    <i class="fas fa-ellipsis-h tool-icon" onclick="toggleMembers()" title="更多信息"></i>
                </div>
            </div>

            <div class="messages-box" id="msgBox">
                </div>

            <div class="input-box">
                <div class="toolbar">
                    <i class="far fa-smile tool-icon"></i>
                    <i class="far fa-image tool-icon"></i>
                    <i class="far fa-folder tool-icon"></i>
                    <i class="fas fa-cut tool-icon"></i>
                    <i class="far fa-clock tool-icon" style="margin-left: auto;"></i>
                </div>
                <textarea id="msgInput"></textarea>
                <div class="send-area">
                    <button class="btn-send" onclick="sendMsg()">发送(S)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="member-sidebar" id="memberSidebar">
        <div class="member-header">群成员 (<span id="memberCount">0</span>)</div>
        <div class="member-scroll" id="memberList">
            </div>
    </div>
</div>

<script src="./app.js"></script>
<script>
    let me = null;
    let ws = null;
    let currentCid = null;
    let currentType = null;

    // 初始化
    (async function init() {
        me = await Dreams.apiMe();
        if (!me) { location.href = "./login.html"; return; }
        
        // 设置我的头像
        document.getElementById("myAvatar").src = me.avatar || "https://via.placeholder.com/40";

        // 加载会话列表
        await refreshConversations();
        
        // 绑定回车发送
        document.getElementById("msgInput").addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });
    })();

    // 刷新列表
    async function refreshConversations() {
        const res = await Dreams.apiGet("/api/conversations");
        const list = document.getElementById("convList");
        list.innerHTML = "";
        
        if (res.items) {
            res.items.forEach(c => {
                const div = document.createElement("div");
                div.className = `session-item ${currentCid === c.id ? 'active' : ''}`;
                div.onclick = () => switchChat(c);
                
                let avatar = c.type === 'group' 
                    ? "https://ui-avatars.com/api/?background=0099ff&color=fff&name=Group" 
                    : "https://ui-avatars.com/api/?background=random&name=User";
                
                const title = c.title || (c.type==='group' ? `群聊 #${c.id}` : `用户 ${c.id}`);

                div.innerHTML = `
                    <img class="s-avatar" src="${avatar}">
                    <div class="s-content">
                        <div class="s-top">
                            <span class="s-name">${title}</span>
                            <span class="s-time">12:30</span>
                        </div>
                        <div class="s-msg">点击查看消息...</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }
    }

    // 切换会话
    async function switchChat(c) {
        if (currentCid === c.id) return;
        currentCid = c.id;
        currentType = c.type;

        // UI 切换
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("chatInterface").style.display = "flex";
        document.getElementById("chatTitle").innerText = c.title || "聊天";
        
        // 刷新列表高亮
        document.querySelectorAll(".session-item").forEach(el => el.classList.remove("active"));
        // (简单重新加载列表以更新高亮，生产环境建议直接操作DOM class)
        refreshConversations();

        // 加载消息
        const box = document.getElementById("msgBox");
        box.innerHTML = "";
        const msgs = await Dreams.apiGet(`/api/conversations/${c.id}/messages?limit=50`);
        if (msgs.items) msgs.items.forEach(m => appendMessage(m));
        
        // WS 连接
        if (ws) ws.close();
        ws = Dreams.connectChat(c.id, (data) => {
            if (data.type === 'message') appendMessage(data);
        });

        // 侧边栏逻辑
        const side = document.getElementById("memberSidebar");
        if (c.type === 'group') {
            side.style.display = "flex";
            loadMembers(c.id);
        } else {
            side.style.display = "none";
        }
    }

    async function loadMembers(cid) {
        const res = await Dreams.apiGet(`/api/conversations/${cid}/members`);
        const list = document.getElementById("memberList");
        list.innerHTML = "";
        if (res.items) {
            document.getElementById("memberCount").innerText = res.items.length;
            res.items.forEach(u => {
                const div = document.createElement("div");
                div.className = "member-item";
                
                let badge = "";
                if (u.role === 'owner') badge = `<span class="badge badge-owner">群主</span>`;
                else if (u.role === 'admin') badge = `<span class="badge badge-admin">管理</span>`;

                const avatar = u.avatar || `https://ui-avatars.com/api/?background=random&name=${u.username}`;

                div.innerHTML = `
                    <img class="m-avatar" src="${avatar}">
                    <span class="m-name">${u.username}</span>
                    ${badge}
                `;
                list.appendChild(div);
            });
        }
    }

    function appendMessage(msg) {
        const box = document.getElementById("msgBox");
        const isMe = (me && msg.sender_uid === me.uid);
        
        const div = document.createElement("div");
        div.className = isMe ? "msg-row me" : "msg-row";
        
        const avatar = msg.sender_avatar || `https://ui-avatars.com/api/?background=random&name=${msg.sender_username}`;
        
        div.innerHTML = `
            <img class="msg-avatar" src="${avatar}">
            <div class="msg-bubble-wrap">
                <div class="msg-name">${msg.sender_username}</div>
                <div class="bubble">${Dreams.escapeHtml(msg.content)}</div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMsg() {
        const input = document.getElementById("msgInput");
        const val = input.value.trim();
        if (!val || !ws) return;
        ws.send(JSON.stringify({ content: val }));
        input.value = "";
    }

    function toggleMembers() {
        if (currentType !== 'group') return;
        const side = document.getElementById("memberSidebar");
        side.style.display = side.style.display === 'none' ? 'flex' : 'none';
    }

    function createNewChat() {
        const peer = prompt("请输入对方的 UID 进行私聊：");
        if (peer) {
            Dreams.apiPost("/api/conversations/private", { peer_uid: peer }).then(() => {
                refreshConversations();
            });
        }
    }
</script>
</body>
</html>
